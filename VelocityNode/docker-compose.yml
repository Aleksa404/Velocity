services:
  # ── Redis 7 (BullMQ message queue) ───────────────────────────
  redis:
    image: redis:7-alpine
    container_name: velocity-redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD:-redisvelpw} --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - velocity-network
    healthcheck:
      test: [ "CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-redisvelpw}", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ── Velocity Backend (Node.js / Express) ─────────────────────
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: velocity-backend
    restart: unless-stopped
    expose:
      - 5000"
    environment:
      NODE_ENV: production
      PORT: 5000
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379
      JWT_SECRET: ${JWT_SECRET}
      YOUTUBE_CLIENT_ID: ${YOUTUBE_CLIENT_ID}
      YOUTUBE_CLIENT_SECRET: ${YOUTUBE_CLIENT_SECRET}
      YOUTUBE_REFRESH_TOKEN: ${YOUTUBE_REFRESH_TOKEN}
      ROOT_ADMIN_EMAIL: ${ROOT_ADMIN_EMAIL}
      ROOT_ADMIN_PASSWORD: ${ROOT_ADMIN_PASSWORD}
      ROOT_ADMIN_NAME: ${ROOT_ADMIN_NAME}
      CORS_ORIGIN: ${CORS_ORIGIN}
    volumes:
      - uploads_data:/app/uploads
      - videos_data:/app/videos
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - velocity-network
    healthcheck:
      test: [ "CMD", "node", "-e", "require('http').get('http://localhost:5000/api/health',(r)=>{process.exit(r.statusCode===200?0:1)}).on('error',()=>process.exit(1))" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  redis_data:
    driver: local
  uploads_data:
    driver: local
  videos_data:
    driver: local

networks:
  velocity-network:
    driver: bridge
